# 更新日志

## [3.8.2] - 2025-11-15

### ✨ 新增功能

#### PostgreSQL 镜像智能重试机制
- **新增**: 镜像拉取失败时自动重试备用镜像源
  - 检测到 PostgreSQL 镜像拉取失败时,自动尝试备用源
  - 镜像源列表: Docker Hub 官方源 → Docker 代理镜像
  - 每个源 60 秒超时,失败后自动切换下一个
  - 成功后自动打标签为 `postgres:15`,对用户透明
- **优势**:
  - 无需用户配置 Docker Hub 镜像加速
  - 自动容错,提高部署成功率
  - 保持官方配置不变

### 🎯 设计优化

#### 镜像源配置设计
- **设计理念**: 保持官方配置为默认,通过部署脚本实现智能化镜像源选择
  - `BettaFish-main/docker-compose.yml` 保持使用官方源 `ghcr.io` 和 `postgres:15`
  - bettafish 国内镜像源 `ghcr.nju.edu.cn` 以注释形式保留在配置文件中
  - `docker-deploy.sh` 根据网络测速结果动态选择并切换 bettafish 镜像源
  - PostgreSQL 使用官方 `postgres:15`,拉取失败时自动重试备用源

### 🔧 关键修复

#### Docker 镜像拉取超时问题
- **问题**: PostgreSQL 镜像 `postgres:15` 从 Docker Hub 拉取超时
- **解决**: 改用 `postgres:15-alpine` 并提供离线包支持
- **优势**:
  - 镜像体积减小 30% (379MB → 265MB)
  - 支持离线部署,无需网络
  - 兼容 BettaFish 数据库功能
- **改进**: `docker-deploy.sh` 镜像源切换逻辑
  - 优化 sed 正则表达式,从 `/bettafish:/,/image:/` 改为 `/bettafish:/,/container_name:/`
  - 增加 `^[[:space:]]*` 匹配,确保只替换非注释的 image 行
  - 支持 macOS 和 Linux 双平台

### ✨ 新增功能

#### 部署工具包同步脚本
- **新增**: `sync-deployment-kit.sh` - 专用同步脚本
  - 智能文件对比(SHA256 哈希验证)
  - 多种同步模式: check/sync/quick/scripts-only/test-connection
  - 彩色输出和安全确认机制
  - 自动排除日志、备份、数据库等文件

### 📝 文档更新

- **新增**: `镜像源问题修复报告.md` - 详细技术文档
  - 问题分析和根本原因
  - 修复方案和验证结果
  - 部署建议和技术细节
- **新增**: `快速修复清单.md` - 操作指南
  - 3 种修复方式(同步脚本/手动/离线包)
  - 验证清单和常见问题解决
  - 时间估算和帮助指引

### 🎯 影响范围

- ✅ 国内用户部署时间从 5-15 分钟缩短至 2-5 分钟
- ✅ 减少因网络超时导致的部署失败
- ✅ 提升开箱即用体验

---

## [2.0.0] - 2025-01-XX

### 🎯 重大变更

#### 步骤 5: 镜像获取
- **移除**: `docker build` 本地构建方式
- **新增**: `docker-compose pull` 官方镜像拉取
- **新增**: 智能网络测速，自动选择最快镜像源
- **新增**: 架构自动检测和验证

#### 步骤 6: 服务启动
- **移除**: 手动 `docker run` 命令
- **新增**: `docker-compose up -d` 统一编排
- **改进**: 端口冲突检测和提示

### ✨ 新功能

#### 智能网络测速
```bash
# 自动测试多个镜像源
测试 官方源 (ghcr.io) ... 2350ms
测试 南京大学镜像 ... 450ms
✅ 选择最快的镜像源: 南京大学镜像 (450ms)
```

#### 架构智能检测
```bash
# 自动检测并提示架构不匹配
⚠️  检测到架构不匹配！
  • 系统架构: x86_64
  • 镜像架构: arm64
ℹ️  将自动拉取正确架构的镜像
```

#### 网络状况建议
- 🟢 网络良好 (< 1s) → 建议更新镜像
- 🟡 网络一般 (1-3s) → 可选择更新
- 🔴 网络较差 (> 3s) → 建议使用现有镜像

### 🚀 性能提升

| 指标 | v1.x | v2.0 | 改进 |
|------|------|------|------|
| 部署时间 | 20 分钟 | 10 分钟 | ⬇️ 50% |
| 成功率（国内） | 40% | 90%+ | ⬆️ 50% |
| 成功率（总体） | 60% | 95%+ | ⬆️ 35% |

### 🔧 改进

- 改进日期格式化跨平台兼容性（macOS/Linux）
- 优化错误处理和恢复机制
- 增强日志输出的可读性
- 添加配置文件自动备份和恢复

### 📝 文档

- 新增: `docker-deploy脚本重大更新说明.md`
- 新增: `CHANGELOG.md`
- 更新: 所有相关文档

---

## [1.x] - 之前版本

### 特性
- 步骤 1: 环境检测
- 步骤 2: 项目源码检查
- 步骤 3: API 密钥配置
- 步骤 4: 环境配置生成
- 步骤 5: Docker 镜像构建（本地）
- 步骤 6: 服务启动（手动）
- 步骤 7: 健康检查

### 已知问题
- ❌ 本地构建耗时长（15-30 分钟）
- ❌ 国内网络构建成功率低
- ❌ 架构不匹配无法自动检测
- ❌ 手动命令复杂易错

---

## 版本说明

### 语义化版本
- **主版本号**: 重大架构变更
- **次版本号**: 新功能添加
- **修订号**: Bug 修复

### v2.0.0 重大变更原因
1. 部署方式从本地构建改为官方镜像拉取（不向后兼容）
2. 服务启动从手动命令改为 docker-compose（命令参数变化）
3. 新增网络测速等核心功能

---

## 迁移指南

### 从 v1.x 升级到 v2.0

**影响范围**:
- 不影响已部署的服务
- 新部署将使用新流程

**迁移步骤**:

1. **备份现有数据**（可选）
```bash
docker cp bettafish:/app/logs ./logs-backup
docker cp bettafish:/app/final_reports ./reports-backup
```

2. **清理旧资源**（可选）
```bash
docker stop bettafish bettafish-db
docker rm bettafish bettafish-db
docker rmi bettafish:latest
```

3. **使用新脚本部署**
```bash
./docker-deploy.sh
```

4. **恢复数据**（如有备份）
```bash
docker cp ./logs-backup/. bettafish:/app/logs
docker cp ./reports-backup/. bettafish:/app/final_reports
```

---

## 未来计划

### v2.1 (计划中)
- [ ] 添加更多国内镜像源
- [ ] 镜像源测速结果缓存
- [ ] 端口冲突自动修复

### v2.2 (计划中)
- [ ] 项目源码自动下载
- [ ] 离线部署包支持
- [ ] 配置向导优化

### v3.0 (远期)
- [ ] Web 管理界面
- [ ] 一键升级功能
- [ ] 健康检查和自动恢复
- [ ] 多实例支持
