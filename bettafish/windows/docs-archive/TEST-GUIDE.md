# Windows 版本测试指南

## 📋 测试前准备

### 环境要求
- Windows 10 (版本 21H2 或更高) / Windows 11
- PowerShell 5.1+ (运行 `$PSVersionTable` 检查)
- Docker Desktop for Windows (从 https://www.docker.com/products/docker-desktop/ 下载)

### 测试账号准备
- OpenAI API Key (必需)
- Firecrawl API Key (可选)

## 🧪 测试场景

### 场景 1: 全新安装测试

**目的**: 测试完整的首次部署流程

**前置条件**:
- [ ] 已安装 Docker Desktop
- [ ] Docker Desktop 正在运行
- [ ] 没有 BettaFish 相关容器
- [ ] 端口 5000 可用

**测试步骤**:
1. 双击 `docker-deploy.bat`
2. 检查是否自动请求管理员权限
3. 观察环境检测输出
4. 输入 OpenAI API Key
5. 跳过 Firecrawl API Key（按回车）
6. 观察镜像拉取过程
7. 等待服务启动
8. 检查显示的访问地址

**预期结果**:
- [x] 环境检测全部通过
- [x] 镜像拉取成功（postgres:15 和 bettafish:latest）
- [x] 服务启动成功
- [x] 防火墙规则创建成功
- [x] 显示本地/局域网/公网访问地址
- [x] 可以通过浏览器访问 http://localhost:5000

**验证命令**:
```powershell
# 检查容器状态
docker ps

# 检查防火墙规则
Get-NetFirewallRule -DisplayName "BettaFish*"

# 测试端口访问
Test-NetConnection -ComputerName localhost -Port 5000
```

---

### 场景 2: Docker Desktop 未运行测试

**目的**: 测试自动启动 Docker Desktop 功能

**前置条件**:
- [ ] 已安装 Docker Desktop
- [ ] Docker Desktop **未运行**

**测试步骤**:
1. 确保 Docker Desktop 已关闭
2. 双击 `docker-deploy.bat`
3. 观察是否检测到 Docker 未运行
4. 观察是否自动启动 Docker Desktop
5. 观察是否等待 Docker 启动（最多 60 秒）

**预期结果**:
- [x] 检测到 Docker 未运行
- [x] 显示"正在尝试启动 Docker Desktop..."
- [x] Docker Desktop 自动启动
- [x] 等待 Docker 就绪
- [x] 继续后续部署流程

---

### 场景 3: 端口冲突测试

**目的**: 测试端口自动切换功能

**前置条件**:
- [ ] 端口 5000 被占用

**制造端口占用**:
```powershell
# 启动一个临时的 Web 服务器占用 5000 端口
python -m http.server 5000
# 或
npx http-server -p 5000
```

**测试步骤**:
1. 确保端口 5000 被占用
2. 运行 `docker-deploy.bat`
3. 观察端口检测输出
4. 检查是否自动切换到 5001-5010

**预期结果**:
- [x] 检测到端口 5000 被占用
- [x] 显示"端口 5000 已被占用"
- [x] 自动查找可用端口（如 5001）
- [x] 显示"找到可用端口: 5001"
- [x] 更新 docker-compose.yml
- [x] 服务在新端口启动
- [x] 防火墙规则使用新端口

**验证**:
```powershell
# 检查实际运行端口
docker ps --format "{{.Ports}}"

# 访问新端口
Start-Process "http://localhost:5001"
```

---

### 场景 4: 重复部署测试

**目的**: 测试更新和重新部署

**前置条件**:
- [ ] 已经部署过 BettaFish
- [ ] 容器正在运行

**测试步骤**:
1. 运行 `docker-deploy.bat`
2. 观察镜像检测
3. 选择"是否拉取最新镜像" → 输入 `y`
4. 观察镜像更新过程

**预期结果**:
- [x] 检测到本地镜像已存在
- [x] 询问是否更新
- [x] 拉取最新镜像
- [x] 重启服务
- [x] 服务正常运行

---

### 场景 5: 无管理员权限测试

**目的**: 测试权限检测和 UAC 提升

**前置条件**:
- [ ] 以普通用户身份运行

**测试步骤**:
1. 不要右键"以管理员身份运行"
2. 直接双击 `docker-deploy.bat`
3. 观察 UAC 提示框

**预期结果**:
- [x] 检测到无管理员权限
- [x] 显示 UAC 提示框
- [x] 点击"是"后以管理员身份重新启动
- [x] 继续正常部署

---

### 场景 6: 诊断工具测试

**目的**: 测试诊断工具的所有功能

**测试步骤**:
1. 双击 `diagnose.bat`
2. 观察所有检查项输出

**预期输出**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 1. 环境检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[✓] PowerShell 5.1
[✓] 管理员权限 - 已获取
[✓] Docker Desktop - Docker version...
[✓] Docker 服务
[✓] 网络连接

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 2. 项目文件检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[✓] BettaFish-main 目录
[✓] docker-compose.yml
[✓] .env 文件 - 已配置
[✓]   OpenAI API Key

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 3. Docker 镜像检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[✓] postgres:15
[✓] bettafish:latest

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 4. Docker 容器状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[✓] bettafish-main-bettafish-1 - Up 2 hours
[✓] bettafish-main-postgres-1 - Up 2 hours

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 5. 端口占用检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[✓] 端口 5000 - 被 Docker 容器使用（正常）
[✓] 端口 5001 - 可用
[✓] 端口 8501 - 被 Docker 容器使用（正常）
[✓] 端口 8502 - 被 Docker 容器使用（正常）
[✓] 端口 8503 - 被 Docker 容器使用（正常）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 6. 防火墙规则检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[✓] BettaFish Main Service - 已启用
[✓] BettaFish Streamlit Services - 已启用

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 7. 服务访问测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  本地 IP: 192.168.1.100
  公网 IP: 101.37.75.125

[✓] BettaFish 主服务 - http://localhost:5000 (HTTP 200)
[✓] Insight Engine - http://localhost:8501 (端口开放)
[✓] Media Engine - http://localhost:8502 (端口开放)
[✓] Query Engine - http://localhost:8503 (端口开放)
```

---

## 🔍 错误场景测试

### 错误 1: Docker Desktop 未安装

**模拟方法**: 卸载 Docker Desktop 或重命名安装目录

**预期输出**:
```
[✗] Docker Desktop - 未安装
[错误] 请先安装 Docker Desktop
```

---

### 错误 2: PowerShell 版本过低

**模拟方法**: 在 PowerShell 2.0 环境测试

**预期输出**:
```
[错误] PowerShell 版本过低
当前版本: 2.0
需要版本: 5.1 或更高
```

---

### 错误 3: 项目目录不存在

**模拟方法**: 删除或重命名 BettaFish-main 目录

**预期输出**:
```
[错误] 未找到 BettaFish-main 目录或 docker-compose.yml 文件
请确保此脚本与 BettaFish-main 目录在同一位置
```

---

### 错误 4: 端口 5000-5010 全部被占用

**模拟方法**: 启动 11 个服务占用所有端口

**预期输出**:
```
[错误] 端口范围 5000-5010 全部被占用
请停止其他服务后重试
```

---

## 📊 测试检查清单

### 基础功能
- [ ] 双击运行 docker-deploy.bat
- [ ] 环境检测通过
- [ ] Docker Desktop 检测
- [ ] 项目目录检测
- [ ] API 配置输入
- [ ] 环境文件生成
- [ ] 镜像拉取
- [ ] 服务启动
- [ ] 防火墙配置
- [ ] 访问地址显示

### 特殊功能
- [ ] UAC 自动提升
- [ ] Docker Desktop 自动启动
- [ ] 端口冲突自动处理
- [ ] 重复部署镜像更新
- [ ] 诊断工具运行

### 错误处理
- [ ] Docker 未安装
- [ ] PowerShell 版本过低
- [ ] 项目目录缺失
- [ ] 端口全部被占用
- [ ] 网络连接失败
- [ ] 镜像拉取失败

### 用户体验
- [ ] 中文界面正常显示
- [ ] 颜色输出正常
- [ ] 进度提示清晰
- [ ] 错误信息友好
- [ ] 成功提示明确

## 🐛 问题报告模板

如果发现问题，请提供以下信息：

```markdown
### 环境信息
- Windows 版本:
- PowerShell 版本:
- Docker Desktop 版本:

### 问题描述
[详细描述问题]

### 重现步骤
1.
2.
3.

### 错误信息
```
[粘贴错误输出]
```

### 日志文件
[附加 logs/ 目录下的日志文件]
```

## ✅ 通过标准

所有测试场景通过，符合以下标准：

1. ✅ 所有基础功能正常运行
2. ✅ 特殊功能按预期工作
3. ✅ 错误处理友好且准确
4. ✅ 用户界面清晰易懂
5. ✅ 部署成功率 100%（在满足前置条件的情况下）

---

**测试日期**: _____________
**测试人员**: _____________
**测试结果**: ☐ 通过  ☐ 失败  ☐ 部分通过

**备注**:
