# BettaFish æ ¸å¿ƒæ–‡ä»¶æ¶æ„

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ BettaFish éƒ¨ç½²å·¥å…·åŒ…çš„æ–‡ä»¶ç»“æ„å’Œæ ¸å¿ƒç»„ä»¶ã€‚

---

## ğŸ“ ç›®å½•ç»“æ„

```
BettaFish-Deployment-Kit/
â”‚
â”œâ”€â”€ docker-deploy.sh                 # ä¸»éƒ¨ç½²è„šæœ¬ (2600+ è¡Œ)
â”œâ”€â”€ .gitignore                       # Git å¿½ç•¥é…ç½®
â”‚
â”œâ”€â”€ BettaFish-main/                  # BettaFish é¡¹ç›®ä¸»ç›®å½•
â”‚   â”œâ”€â”€ docker-compose.yml           # Docker Compose é…ç½®
â”‚   â”œâ”€â”€ .env                         # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆéƒ¨ç½²æ—¶ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
â”‚   â”œâ”€â”€ requirements.txt             # Python ä¾èµ–
â”‚   â”œâ”€â”€ app/                         # åº”ç”¨ç¨‹åºä»£ç 
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py                  # Flask ä¸»å…¥å£
â”‚   â”‚   â”œâ”€â”€ models/                  # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ routes/                  # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ services/                # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ engines/                     # LLM å¼•æ“ç›®å½•
â”‚   â”‚   â”œâ”€â”€ insight/                 # æ´å¯Ÿå¼•æ“
â”‚   â”‚   â”œâ”€â”€ media/                   # åª’ä½“å¼•æ“
â”‚   â”‚   â”œâ”€â”€ query/                   # æŸ¥è¯¢å¼•æ“
â”‚   â”‚   â”œâ”€â”€ code/                    # ä»£ç å¼•æ“
â”‚   â”‚   â”œâ”€â”€ main_agent/              # ä¸»ä»£ç†å¼•æ“
â”‚   â”‚   â”œâ”€â”€ deepseek_agent/          # DeepSeek å¼•æ“
â”‚   â”‚   â””â”€â”€ openai_agent/            # OpenAI å¼•æ“
â”‚   â”‚
â”‚   â”œâ”€â”€ streamlit_apps/              # Streamlit UI ç›®å½•
â”‚   â”‚   â”œâ”€â”€ insight_ui.py            # Insight Engine UI (ç«¯å£ 8501)
â”‚   â”‚   â”œâ”€â”€ media_ui.py              # Media Engine UI (ç«¯å£ 8502)
â”‚   â”‚   â””â”€â”€ query_ui.py              # Query Engine UI (ç«¯å£ 8503)
â”‚   â”‚
â”‚   â””â”€â”€ database/                    # æ•°æ®åº“ç›¸å…³
â”‚       â”œâ”€â”€ migrations/              # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚       â””â”€â”€ init.sql                 # åˆå§‹åŒ– SQL
â”‚
â”œâ”€â”€ backups/                         # å¤‡ä»½ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ env_backup_YYYYMMDD_HHMMSS.env
â”‚   â”œâ”€â”€ docker-compose_backup_YYYYMMDD_HHMMSS.yml
â”‚   â””â”€â”€ docker-compose_port_XXXX_YYYYMMDD_HHMMSS.yml
â”‚
â”œâ”€â”€ logs/                            # æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â””â”€â”€ deploy_YYYYMMDD_HHMMSS.log
â”‚
â””â”€â”€ docs/                            # æ–‡æ¡£ç›®å½•
    â”œâ”€â”€ README.md                    # ä¸»æ–‡æ¡£
    â”‚
    â”œâ”€â”€ guides/                      # ç”¨æˆ·æŒ‡å—
    â”‚   â”œâ”€â”€ å¿«é€Ÿå¼€å§‹æŒ‡å—.md
    â”‚   â”œâ”€â”€ ç”¨æˆ·æ‰‹å†Œ.md
    â”‚   â””â”€â”€ æ•…éšœæ’æŸ¥æŒ‡å—.md
    â”‚
    â”œâ”€â”€ technical/                   # æŠ€æœ¯æ–‡æ¡£
    â”‚   â”œâ”€â”€ æŠ€æœ¯æ–‡æ¡£.md
    â”‚   â”œâ”€â”€ æ ¸å¿ƒæ¶æ„.mdï¼ˆæœ¬æ–‡æ¡£ï¼‰
    â”‚   â””â”€â”€ APIå‚è€ƒ.md
    â”‚
    â””â”€â”€ images/                      # æ–‡æ¡£å›¾ç‰‡
        â””â”€â”€ (screenshots, diagrams)
```

---

## ğŸ”‘ æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### 1. docker-deploy.sh

**ç±»å‹**: Bash Shell è„šæœ¬
**å¤§å°**: ~2600 è¡Œ
**æƒé™**: å¯æ‰§è¡Œ (`chmod +x`)

**åŠŸèƒ½**:
- ç¯å¢ƒæ£€æµ‹ä¸ä¾èµ–å®‰è£…
- API å¯†é’¥é…ç½®
- é•œåƒæºæ™ºèƒ½é€‰æ‹©
- è‡ªåŠ¨ç«¯å£å†²çªä¿®å¤
- å®¹å™¨å’Œé•œåƒæ¸…ç†
- æœåŠ¡éƒ¨ç½²å’Œå¥åº·æ£€æŸ¥
- å¤‡ä»½å’Œæ—¥å¿—ç®¡ç†

**æ ¸å¿ƒå‡½æ•°**:

| å‡½æ•°å | è¡Œæ•°èŒƒå›´ | åŠŸèƒ½ |
|--------|---------|------|
| `log_info()` | 110-115 | è¾“å‡ºä¿¡æ¯æ—¥å¿— |
| `log_success()` | 116-121 | è¾“å‡ºæˆåŠŸæ—¥å¿— |
| `log_warn()` | 122-127 | è¾“å‡ºè­¦å‘Šæ—¥å¿— |
| `log_error()` | 128-133 | è¾“å‡ºé”™è¯¯æ—¥å¿— |
| `command_exists()` | 160-165 | æ£€æµ‹å‘½ä»¤æ˜¯å¦å­˜åœ¨ |
| `check_port_available()` | 2352-2362 | æ£€æµ‹ç«¯å£æ˜¯å¦å¯ç”¨ |
| `find_available_port()` | 2364-2375 | æŸ¥æ‰¾å¯ç”¨ç«¯å£ (5001-5010) |
| `test_registry_speed()` | 2080-2095 | æµ‹è¯•é•œåƒæºé€Ÿåº¦ |

**æ‰§è¡Œæµç¨‹**:
```
æ­¥éª¤ 1: ç¯å¢ƒæ£€æµ‹ â†’ æ­¥éª¤ 2: æ–‡ä»¶æ£€æŸ¥ â†’ æ­¥éª¤ 3: API é…ç½® â†’
æ­¥éª¤ 4: ç”Ÿæˆ .env â†’ æ­¥éª¤ 5: æ‹‰å–é•œåƒ â†’ æ­¥éª¤ 6: å¯åŠ¨æœåŠ¡ â†’
æ­¥éª¤ 7: å¥åº·æ£€æŸ¥ â†’ éƒ¨ç½²å®Œæˆ
```

**ä¾èµ–æ£€æµ‹**:
- Docker (å¿…éœ€)
- Docker Compose (å¿…éœ€)
- curl (å¿…éœ€ï¼Œç”¨äºç½‘ç»œæµ‹è¯•)
- git (å¯é€‰ï¼Œç”¨äºä¸‹è½½é¡¹ç›®)
- lsof æˆ– nc (å¯é€‰ï¼Œç”¨äºç«¯å£æ£€æµ‹)

---

### 2. docker-compose.yml

**ç±»å‹**: YAML é…ç½®æ–‡ä»¶
**ç‰ˆæœ¬**: 3.8
**ä½ç½®**: `BettaFish-main/docker-compose.yml`

**å®šä¹‰çš„æœåŠ¡**:

#### æœåŠ¡ 1: bettafish (ä¸»åº”ç”¨)
```yaml
services:
  bettafish:
    image: ghcr.io/666ghj/bettafish:latest
    container_name: bettafish
    ports:
      - "5000:5000"    # Flask ä¸»æœåŠ¡
      - "8501:8501"    # Insight Engine
      - "8502:8502"    # Media Engine
      - "8503:8503"    # Query Engine
    env_file:
      - .env
    depends_on:
      - db
    networks:
      - bettafish-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 30s
      timeout: 10s
      retries: 3
```

**å…³é”®é…ç½®**:
- **é•œåƒ**: ç”±è„šæœ¬æ ¹æ®æµ‹é€Ÿç»“æœåŠ¨æ€ä¿®æ”¹
- **ç«¯å£**: å¦‚é‡å†²çªï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ä¿®æ”¹ 5000 â†’ 5001-5010
- **ç¯å¢ƒå˜é‡**: ä» `.env` åŠ è½½
- **ä¾èµ–**: ç­‰å¾… `db` æœåŠ¡å¯åŠ¨
- **é‡å¯**: å¼‚å¸¸é€€å‡ºè‡ªåŠ¨é‡å¯
- **å¥åº·æ£€æŸ¥**: æ¯ 30 ç§’æ£€æŸ¥æœåŠ¡çŠ¶æ€

#### æœåŠ¡ 2: db (æ•°æ®åº“)
```yaml
services:
  db:
    image: postgres:15
    container_name: bettafish-db
    environment:
      POSTGRES_USER: bettafish
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: bettafish
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - bettafish_db_data:/var/lib/postgresql/data
    networks:
      - bettafish-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bettafish"]
      interval: 10s
      timeout: 5s
      retries: 5
```

**å…³é”®é…ç½®**:
- **é•œåƒ**: PostgreSQL 15 å®˜æ–¹é•œåƒ
- **å­—ç¬¦é›†**: UTF-8
- **æŒä¹…åŒ–**: ä½¿ç”¨ Docker Volume
- **å¥åº·æ£€æŸ¥**: æ¯ 10 ç§’æ£€æŸ¥æ•°æ®åº“å°±ç»ªçŠ¶æ€

#### ç½‘ç»œé…ç½®
```yaml
networks:
  bettafish-network:
    driver: bridge
```

**ç‰¹æ€§**:
- éš”ç¦»çš„ bridge ç½‘ç»œ
- å®¹å™¨é—´é€šè¿‡æœåŠ¡åé€šä¿¡
- è‡ªåŠ¨ DNS è§£æ

#### æ•°æ®å·é…ç½®
```yaml
volumes:
  bettafish_db_data:
    driver: local
```

**ç‰¹æ€§**:
- æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨
- å®¹å™¨åˆ é™¤åæ•°æ®ä¿ç•™
- ä»… `docker-compose down -v` ä¼šåˆ é™¤

---

### 3. .env æ–‡ä»¶

**ç±»å‹**: ç¯å¢ƒå˜é‡é…ç½®
**ç”Ÿæˆ**: ç”± `docker-deploy.sh` è‡ªåŠ¨ç”Ÿæˆ
**ä½ç½®**: `BettaFish-main/.env`

**æ–‡ä»¶ç»“æ„**: (å…± 50+ è¡Œ)

```ini
# ==================== æœåŠ¡é…ç½® ====================
HOST=0.0.0.0
PORT=5000

# ==================== æ•°æ®åº“é…ç½® ====================
DB_HOST=db
DB_PORT=5432
DB_USER=bettafish
DB_PASSWORD=bettafish_secure_TIMESTAMP
DB_NAME=bettafish
DB_CHARSET=utf8mb4
DB_DIALECT=postgresql

# ==================== 7 ä¸ª LLM å¼•æ“é…ç½® ====================
# æ¯ä¸ªå¼•æ“åŒ…å« 3 ä¸ªå˜é‡:
# - {ENGINE}_API_KEY          (API å¯†é’¥)
# - {ENGINE}_BASE_URL          (Base URLï¼Œå›ºå®š)
# - {ENGINE}_MODEL_NAME        (æ¨¡å‹åç§°)

# 1. Insight Engine
INSIGHT_ENGINE_API_KEY=sk-proj-...
INSIGHT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
INSIGHT_ENGINE_MODEL_NAME=gpt-4o

# 2. Media Engine
MEDIA_ENGINE_API_KEY=sk-proj-...
MEDIA_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
MEDIA_ENGINE_MODEL_NAME=gpt-4o

# 3. Query Engine
QUERY_ENGINE_API_KEY=sk-proj-...
QUERY_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
QUERY_ENGINE_MODEL_NAME=gpt-4o

# 4. Code Engine
CODE_ENGINE_API_KEY=sk-proj-...
CODE_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
CODE_ENGINE_MODEL_NAME=gpt-4o

# 5. Main Agent Engine
MAIN_AGENT_ENGINE_API_KEY=sk-proj-...
MAIN_AGENT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
MAIN_AGENT_ENGINE_MODEL_NAME=gpt-4o

# 6. DeepSeek Agent Engine
DEEPSEEK_AGENT_ENGINE_API_KEY=sk-proj-...
DEEPSEEK_AGENT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
DEEPSEEK_AGENT_ENGINE_MODEL_NAME=deepseek-chat

# 7. OpenAI Agent Engine
OPENAI_AGENT_ENGINE_API_KEY=sk-proj-...
OPENAI_AGENT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
OPENAI_AGENT_ENGINE_MODEL_NAME=gpt-4o

# ==================== æœç´¢å·¥å…·é…ç½® ====================
TAVILY_API_KEY=tvly-...
BOCHA_WEB_SEARCH_API_KEY=bocha-...

# ==================== å…¶ä»–é…ç½® ====================
LOG_LEVEL=INFO
FLASK_ENV=production
```

**é…ç½®é€»è¾‘**:
- æ‰€æœ‰å¼•æ“ä½¿ç”¨åŒä¸€ä¸ªä¸» API å¯†é’¥
- Base URL å›ºå®šä¸º `https://vibecodingapi.ai/v1`
- æ•°æ®åº“å¯†ç åŠ¨æ€ç”Ÿæˆï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
- æ”¯æŒ Tavily å’Œ Bocha ä¸¤ç§æœç´¢å·¥å…·

**å®‰å…¨æ€§**:
- âœ… å·²åŠ å…¥ `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- âœ… ä»…åœ¨æœ¬åœ°å­˜å‚¨
- âœ… ä¿®æ”¹å‰è‡ªåŠ¨å¤‡ä»½åˆ° `backups/`

---

### 4. .gitignore

**ç±»å‹**: Git å¿½ç•¥é…ç½®
**ä½ç½®**: `BettaFish-Deployment-Kit/.gitignore`

**å†…å®¹**:
```gitignore
# ç¯å¢ƒé…ç½®æ–‡ä»¶
.env
*.env
!.env.example

# å¤‡ä»½æ–‡ä»¶
backups/
*.bak
*.backup

# æ—¥å¿—æ–‡ä»¶
logs/
*.log

# Docker ç›¸å…³
docker-compose.override.yml

# Python ç›¸å…³
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
*.so

# IDE ç›¸å…³
.vscode/
.idea/
*.swp
*.swo
*~

# macOS
.DS_Store

# ä¸´æ—¶æ–‡ä»¶
tmp/
temp/
*.tmp
```

**ç”¨é€”**:
- é˜²æ­¢æ•æ„Ÿä¿¡æ¯ï¼ˆAPI å¯†é’¥ï¼‰æ³„éœ²
- é¿å…æäº¤è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶
- ä¿æŒä»“åº“æ•´æ´

---

### 5. å¤‡ä»½æ–‡ä»¶

**ä½ç½®**: `backups/` ç›®å½•

**æ–‡ä»¶ç±»å‹**:

#### .env é…ç½®å¤‡ä»½
```
æ–‡ä»¶å: env_backup_YYYYMMDD_HHMMSS.env
ç¤ºä¾‹: env_backup_20250114_143025.env
å¤§å°: ~2KB
```

**è§¦å‘æ¡ä»¶**:
- ç”¨æˆ·é‡æ–°è¾“å…¥é…ç½®
- Bocha API å¯†é’¥å‘ç”Ÿå˜åŒ–

#### docker-compose.yml é•œåƒæºå¤‡ä»½
```
æ–‡ä»¶å: docker-compose_backup_YYYYMMDD_HHMMSS.yml
ç¤ºä¾‹: docker-compose_backup_20250114_143030.yml
å¤§å°: ~1.5KB
```

**è§¦å‘æ¡ä»¶**:
- é•œåƒæºå®é™…åˆ‡æ¢ï¼ˆå®˜æ–¹ â†” å—äº¬å¤§å­¦ï¼‰

#### docker-compose.yml ç«¯å£é…ç½®å¤‡ä»½
```
æ–‡ä»¶å: docker-compose_port_XXXX_YYYYMMDD_HHMMSS.yml
ç¤ºä¾‹: docker-compose_port_5001_20250114_143035.yml
å¤§å°: ~1.5KB
```

**è§¦å‘æ¡ä»¶**:
- ç«¯å£ 5000 è¢«å ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–ç«¯å£

**å¤‡ä»½ç®¡ç†**:
- è‡ªåŠ¨åˆ›å»ºæ—¶é—´æˆ³
- ä¸ä¼šè¦†ç›–æ—§å¤‡ä»½
- å¯æ‰‹åŠ¨åˆ é™¤è¿‡æœŸå¤‡ä»½
- æ¢å¤æ–¹æ³•: å¤åˆ¶å¤‡ä»½æ–‡ä»¶å¹¶é‡å‘½å

---

### 6. æ—¥å¿—æ–‡ä»¶

**ä½ç½®**: `logs/` ç›®å½•

**æ–‡ä»¶ç±»å‹**:

#### éƒ¨ç½²æ—¥å¿—
```
æ–‡ä»¶å: deploy_YYYYMMDD_HHMMSS.log
ç¤ºä¾‹: deploy_20250114_143020.log
å¤§å°: 10-50KBï¼ˆå–å†³äºè¾“å‡ºè¯¦ç»†ç¨‹åº¦ï¼‰
```

**å†…å®¹**:
- æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´
- å‘½ä»¤è¾“å‡º
- é”™è¯¯ä¿¡æ¯
- è­¦å‘Šæç¤º

**æ—¥å¿—æ ¼å¼**:
```
[2025-01-14 14:30:20] â„¹ï¸  æ£€æµ‹ Docker...
[2025-01-14 14:30:21] âœ… Docker å·²å®‰è£… (ç‰ˆæœ¬: 24.0.6)
[2025-01-14 14:30:22] â„¹ï¸  æ£€æµ‹ Docker Compose...
[2025-01-14 14:30:23] âœ… Docker Compose å·²å®‰è£… (ç‰ˆæœ¬: 2.23.0)
```

**ç”¨é€”**:
- é—®é¢˜æ’æŸ¥
- éƒ¨ç½²å®¡è®¡
- æ€§èƒ½åˆ†æ

---

## ğŸ—ï¸ BettaFish åº”ç”¨æ¶æ„

### ä¸»åº”ç”¨ç»“æ„

```
BettaFish-main/app/
â”‚
â”œâ”€â”€ __init__.py                      # Flask åº”ç”¨åˆå§‹åŒ–
â”œâ”€â”€ main.py                          # ä¸»å…¥å£ç‚¹
â”‚
â”œâ”€â”€ models/                          # æ•°æ®æ¨¡å‹ (SQLAlchemy ORM)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user.py                      # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ conversation.py              # å¯¹è¯æ¨¡å‹
â”‚   â”œâ”€â”€ message.py                   # æ¶ˆæ¯æ¨¡å‹
â”‚   â””â”€â”€ session.py                   # ä¼šè¯æ¨¡å‹
â”‚
â”œâ”€â”€ routes/                          # è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ api.py                       # API è·¯ç”±
â”‚   â”œâ”€â”€ chat.py                      # èŠå¤©è·¯ç”±
â”‚   â””â”€â”€ admin.py                     # ç®¡ç†è·¯ç”±
â”‚
â”œâ”€â”€ services/                        # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ llm_service.py               # LLM æœåŠ¡è°ƒç”¨
â”‚   â”œâ”€â”€ search_service.py            # æœç´¢æœåŠ¡ (Tavily/Bocha)
â”‚   â”œâ”€â”€ database_service.py          # æ•°æ®åº“æ“ä½œ
â”‚   â””â”€â”€ auth_service.py              # è®¤è¯æœåŠ¡
â”‚
â””â”€â”€ utils/                           # å·¥å…·å‡½æ•°
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ logger.py                    # æ—¥å¿—å·¥å…·
    â”œâ”€â”€ validator.py                 # éªŒè¯å·¥å…·
    â””â”€â”€ helpers.py                   # è¾…åŠ©å‡½æ•°
```

### LLM å¼•æ“æ¶æ„

```
BettaFish-main/engines/
â”‚
â”œâ”€â”€ insight/                         # æ´å¯Ÿå¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ engine.py                    # å¼•æ“ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ prompts.py                   # æç¤ºè¯æ¨¡æ¿
â”‚   â””â”€â”€ tools.py                     # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ media/                           # åª’ä½“å¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ engine.py
â”‚   â”œâ”€â”€ image_handler.py             # å›¾åƒå¤„ç†
â”‚   â”œâ”€â”€ video_handler.py             # è§†é¢‘å¤„ç†
â”‚   â””â”€â”€ audio_handler.py             # éŸ³é¢‘å¤„ç†
â”‚
â”œâ”€â”€ query/                           # æŸ¥è¯¢å¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ engine.py
â”‚   â”œâ”€â”€ search_integration.py        # æœç´¢é›†æˆ
â”‚   â””â”€â”€ result_processor.py          # ç»“æœå¤„ç†
â”‚
â”œâ”€â”€ code/                            # ä»£ç å¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ engine.py
â”‚   â”œâ”€â”€ code_analyzer.py             # ä»£ç åˆ†æ
â”‚   â””â”€â”€ code_generator.py            # ä»£ç ç”Ÿæˆ
â”‚
â”œâ”€â”€ main_agent/                      # ä¸»ä»£ç†å¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ agent.py                     # ä»£ç†é€»è¾‘
â”‚   â”œâ”€â”€ task_planner.py              # ä»»åŠ¡è§„åˆ’
â”‚   â””â”€â”€ executor.py                  # æ‰§è¡Œå™¨
â”‚
â”œâ”€â”€ deepseek_agent/                  # DeepSeek å¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ agent.py
â”‚
â””â”€â”€ openai_agent/                    # OpenAI å¼•æ“
    â”œâ”€â”€ __init__.py
    â””â”€â”€ agent.py
```

### å¼•æ“é…ç½®æ˜ å°„

| å¼•æ“åç§° | ç¯å¢ƒå˜é‡å‰ç¼€ | é»˜è®¤æ¨¡å‹ | Streamlit UI | ç«¯å£ |
|---------|------------|---------|-------------|------|
| Insight | `INSIGHT_ENGINE_` | gpt-4o | âœ… | 8501 |
| Media | `MEDIA_ENGINE_` | gpt-4o | âœ… | 8502 |
| Query | `QUERY_ENGINE_` | gpt-4o | âœ… | 8503 |
| Code | `CODE_ENGINE_` | gpt-4o | âŒ | - |
| Main Agent | `MAIN_AGENT_ENGINE_` | gpt-4o | âŒ | - |
| DeepSeek | `DEEPSEEK_AGENT_ENGINE_` | deepseek-chat | âŒ | - |
| OpenAI | `OPENAI_AGENT_ENGINE_` | gpt-4o | âŒ | - |

---

## ğŸ”„ æ•°æ®æµ

### éƒ¨ç½²æµç¨‹æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ API å¯†é’¥
    â†“
è„šæœ¬éªŒè¯å¹¶å­˜å‚¨åˆ°å˜é‡
    â†“
ç”Ÿæˆ .env æ–‡ä»¶ï¼ˆ7 ä¸ªå¼•æ“å…±äº«å¯†é’¥ï¼‰
    â†“
docker-compose è¯»å– .env
    â†“
ä¼ é€’ç»™å®¹å™¨ç¯å¢ƒå˜é‡
    â†“
åº”ç”¨è¯»å–ç¯å¢ƒå˜é‡åˆå§‹åŒ–å¼•æ“
    â†“
æœåŠ¡å¯åŠ¨å®Œæˆ
```

### è¿è¡Œæ—¶æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚ â†’ Flask è·¯ç”± â†’ ä¸šåŠ¡é€»è¾‘å±‚ â†’ LLM å¼•æ“
                                          â†“
ç”¨æˆ·å“åº” â† æ ¼å¼åŒ–è¾“å‡º â† ç»“æœå¤„ç† â† API è°ƒç”¨
```

### æ•°æ®åº“æ•°æ®æµ

```
åº”ç”¨è¯·æ±‚ â†’ SQLAlchemy ORM â†’ PostgreSQL é©±åŠ¨
                               â†“
åº”ç”¨æ•°æ® â† ORM æ˜ å°„ â† SQL æŸ¥è¯¢ç»“æœ
```

---

## ğŸ“¦ Docker é•œåƒå±‚æ¬¡

### bettafish:latest é•œåƒç»“æ„

```
FROM python:3.11-slim                # åŸºç¡€å±‚ (~150MB)
â”‚
â”œâ”€â”€ ç³»ç»Ÿä¾èµ–å®‰è£…                      # ä¸­é—´å±‚ (~100MB)
â”‚   â”œâ”€â”€ curl, git
â”‚   â”œâ”€â”€ postgresql-client
â”‚   â””â”€â”€ å…¶ä»–å·¥å…·
â”‚
â”œâ”€â”€ Python ä¾èµ–å®‰è£…                   # åº”ç”¨å±‚ (~800MB)
â”‚   â”œâ”€â”€ Flask, SQLAlchemy
â”‚   â”œâ”€â”€ Streamlit
â”‚   â”œâ”€â”€ OpenAI SDK
â”‚   â”œâ”€â”€ Langchain
â”‚   â””â”€â”€ å…¶ä»– Python åŒ…
â”‚
â”œâ”€â”€ åº”ç”¨ä»£ç å¤åˆ¶                      # ä»£ç å±‚ (~50MB)
â”‚   â”œâ”€â”€ /app
â”‚   â”œâ”€â”€ /engines
â”‚   â””â”€â”€ /streamlit_apps
â”‚
â””â”€â”€ å…¥å£ç‚¹é…ç½®                        # é…ç½®å±‚ (~1MB)
    â”œâ”€â”€ CMD ["python", "app/main.py"]
    â””â”€â”€ EXPOSE 5000 8501 8502 8503

æ€»å¤§å°: ~1.1GB (å‹ç¼©å ~4.89GB)
```

### postgres:15 é•œåƒç»“æ„

```
FROM debian:bookworm-slim            # åŸºç¡€å±‚ (~80MB)
â”‚
â”œâ”€â”€ PostgreSQL 15 å®‰è£…               # æ•°æ®åº“å±‚ (~200MB)
â”‚   â”œâ”€â”€ PostgreSQL æœåŠ¡å™¨
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯å·¥å…·
â”‚   â””â”€â”€ æ‰©å±•
â”‚
â””â”€â”€ æ•°æ®ç›®å½•åˆå§‹åŒ–                    # é…ç½®å±‚ (~5MB)
    â””â”€â”€ VOLUME /var/lib/postgresql/data

æ€»å¤§å°: ~285MB (æ˜¾ç¤ºä¸º 378MB)
```

---

## ğŸ”Œ ç«¯å£åˆ†é…

### å¯¹å¤–æš´éœ²çš„ç«¯å£

| ç«¯å£ | æœåŠ¡ | åè®® | è¯´æ˜ |
|------|------|------|------|
| 5000 | Flask ä¸»æœåŠ¡ | HTTP | ä¸» Web ç•Œé¢å’Œ API |
| 8501 | Insight Engine UI | HTTP | Streamlit ç•Œé¢ |
| 8502 | Media Engine UI | HTTP | Streamlit ç•Œé¢ |
| 8503 | Query Engine UI | HTTP | Streamlit ç•Œé¢ |
| 5432 | PostgreSQL | TCP | æ•°æ®åº“æœåŠ¡ |

### å®¹å™¨å†…éƒ¨ç«¯å£

| ç«¯å£ | ç”¨é€” |
|------|------|
| 5000 | Flask ç›‘å¬ç«¯å£ |
| 8501-8503 | Streamlit ç›‘å¬ç«¯å£ |
| 5432 | PostgreSQL ç›‘å¬ç«¯å£ |

---

## ğŸ” æ•æ„Ÿä¿¡æ¯ç®¡ç†

### æ•æ„Ÿæ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ•æ„Ÿä¿¡æ¯ | ä¿æŠ¤æªæ–½ |
|------|---------|---------|
| `.env` | API å¯†é’¥ã€æ•°æ®åº“å¯†ç  | `.gitignore`ã€è‡ªåŠ¨å¤‡ä»½ |
| `backups/*.env` | å†å² API å¯†é’¥ | `.gitignore` |
| `logs/*.log` | å¯èƒ½åŒ…å«å¯†é’¥ç‰‡æ®µ | `.gitignore` |

### å®‰å…¨æ£€æŸ¥æ¸…å•

- [x] `.env` å·²åŠ å…¥ `.gitignore`
- [x] `backups/` å·²åŠ å…¥ `.gitignore`
- [x] `logs/` å·²åŠ å…¥ `.gitignore`
- [x] æ•°æ®åº“å¯†ç åŠ¨æ€ç”Ÿæˆ
- [x] API å¯†é’¥ä¸ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- [x] Docker å®¹å™¨é—´é€šè¿‡å†…éƒ¨ç½‘ç»œé€šä¿¡

---

## ğŸ“ˆ æ‰©å±•æ€§è€ƒè™‘

### æ·»åŠ æ–°å¼•æ“

**æ­¥éª¤**:
1. åœ¨ `BettaFish-main/engines/` åˆ›å»ºæ–°å¼•æ“ç›®å½•
2. åœ¨ `.env` æ·»åŠ æ–°å¼•æ“é…ç½®ï¼ˆ3 ä¸ªå˜é‡ï¼‰
3. ä¿®æ”¹ `docker-deploy.sh` ç”Ÿæˆ `.env` çš„éƒ¨åˆ†
4. åœ¨åº”ç”¨ä¸­æ³¨å†Œæ–°å¼•æ“

### æ·»åŠ æ–°æœåŠ¡

**æ­¥éª¤**:
1. åœ¨ `docker-compose.yml` æ·»åŠ æ–°æœåŠ¡å®šä¹‰
2. é…ç½®ç½‘ç»œã€ç«¯å£ã€æ•°æ®å·
3. åœ¨ `docker-deploy.sh` æ·»åŠ å¥åº·æ£€æŸ¥
4. æ›´æ–°æ–‡æ¡£

### æ”¯æŒæ›´å¤šé•œåƒæº

**æ­¥éª¤**:
1. åœ¨ `docker-deploy.sh` æ·»åŠ æ–°é•œåƒæº URL
2. åœ¨æµ‹é€Ÿé€»è¾‘ä¸­æ·»åŠ æ–°æº
3. ä¿®æ”¹é•œåƒæºé€‰æ‹©é€»è¾‘
4. æ›´æ–°å¤‡ä»½é€»è¾‘

---

## ğŸ› ï¸ ç»´æŠ¤å»ºè®®

### å®šæœŸä»»åŠ¡

**æ¯æœˆ**:
- æ›´æ–° Docker é•œåƒ: `docker-compose pull`
- æ¸…ç†æ—§æ—¥å¿—: `find logs/ -mtime +30 -delete`
- æ¸…ç†æ—§å¤‡ä»½: `find backups/ -mtime +30 -delete`

**æ¯å­£åº¦**:
- æ›´æ–°éƒ¨ç½²è„šæœ¬
- æ£€æŸ¥å®‰å…¨æ¼æ´: `docker scout cves`
- å¤‡ä»½æ•°æ®åº“: `pg_dump`

**æ¯å¹´**:
- å®¡æŸ¥é…ç½®æ–‡ä»¶
- æ›´æ–°æ–‡æ¡£
- é‡æ–°è¯„ä¼°èµ„æºé…ç½®

### ç›‘æ§æŒ‡æ ‡

**å®¹å™¨å¥åº·**:
```bash
docker-compose ps
docker stats
```

**æ•°æ®åº“å¥åº·**:
```bash
docker-compose exec db pg_isready
```

**ç£ç›˜ä½¿ç”¨**:
```bash
docker system df
du -sh backups/ logs/
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿå¼€å§‹æŒ‡å—](../guides/å¿«é€Ÿå¼€å§‹æŒ‡å—.md) - 5 åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²
- [æŠ€æœ¯æ–‡æ¡£](./æŠ€æœ¯æ–‡æ¡£.md) - è¯¦ç»†æŠ€æœ¯è¯´æ˜
- [æ•…éšœæ’æŸ¥æŒ‡å—](../guides/æ•…éšœæ’æŸ¥æŒ‡å—.md) - å¸¸è§é—®é¢˜è§£å†³

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0
**æœ€åæ›´æ–°**: 2025-01-14
**ç»´æŠ¤è€…**: BettaFish å¼€å‘å›¢é˜Ÿ
