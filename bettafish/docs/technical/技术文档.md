# BettaFish éƒ¨ç½²å·¥å…·æŠ€æœ¯æ–‡æ¡£

æœ¬æ–‡æ¡£é¢å‘å¼€å‘è€…å’Œé«˜çº§ç”¨æˆ·ï¼Œè¯¦ç»†è¯´æ˜ BettaFish éƒ¨ç½²å·¥å…·çš„æŠ€æœ¯å®ç°ã€æ¶æ„è®¾è®¡å’Œé«˜çº§é…ç½®ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
2. [éƒ¨ç½²è„šæœ¬è¯¦è§£](#éƒ¨ç½²è„šæœ¬è¯¦è§£)
3. [Docker é…ç½®](#docker-é…ç½®)
4. [ç¯å¢ƒå˜é‡](#ç¯å¢ƒå˜é‡)
5. [ç½‘ç»œæ¶æ„](#ç½‘ç»œæ¶æ„)
6. [æ•°æ®æŒä¹…åŒ–](#æ•°æ®æŒä¹…åŒ–)
7. [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)
8. [å¼€å‘è°ƒè¯•](#å¼€å‘è°ƒè¯•)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
10. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æµè§ˆå™¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”œâ”€â”€â”€â”€ http://localhost:5000 â”€â”€â”€â”€â”
                          â”œâ”€â”€â”€â”€ http://localhost:8501 â”€â”€â”€â”€â”¤
                          â”œâ”€â”€â”€â”€ http://localhost:8502 â”€â”€â”€â”€â”¤
                          â””â”€â”€â”€â”€ http://localhost:8503 â”€â”€â”€â”€â”¤
                                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                    Docker Network (bettafish-network)
â”‚
â”œâ”€â”€ bettafish (ä¸»å®¹å™¨)                    Port: 5000 â†’ 5000
â”‚   â”œâ”€â”€ Flask åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ 7 ä¸ª LLM å¼•æ“
â”‚   â”‚   â”œâ”€â”€ Main Agent Engine         (API: VibeAI)
â”‚   â”‚   â”œâ”€â”€ Insight Engine            (API: VibeAI)
â”‚   â”‚   â”œâ”€â”€ Media Engine              (API: VibeAI)
â”‚   â”‚   â”œâ”€â”€ Query Engine              (API: VibeAI)
â”‚   â”‚   â”œâ”€â”€ Code Engine               (API: VibeAI)
â”‚   â”‚   â”œâ”€â”€ DeepSeek Agent Engine     (API: VibeAI)
â”‚   â”‚   â””â”€â”€ OpenAI Agent Engine       (API: VibeAI)
â”‚   â”œâ”€â”€ Streamlit ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ Insight UI                 Port: 8501
â”‚   â”‚   â”œâ”€â”€ Media UI                   Port: 8502
â”‚   â”‚   â””â”€â”€ Query UI                   Port: 8503
â”‚   â””â”€â”€ å·¥å…·é›†æˆ
â”‚       â”œâ”€â”€ Tavily Search
â”‚       â””â”€â”€ Bocha Search
â”‚
â””â”€â”€ bettafish-db (æ•°æ®åº“å®¹å™¨)            Port: 5432 â†’ 5432
    â”œâ”€â”€ PostgreSQL 15
    â”œâ”€â”€ æŒä¹…åŒ–å­˜å‚¨: bettafish_db_data
    â””â”€â”€ å­—ç¬¦é›†: UTF-8
```

### æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| å®¹å™¨åŒ– | Docker | 24.0+ |
| ç¼–æ’å·¥å…· | Docker Compose | 2.0+ |
| åç«¯æ¡†æ¶ | Flask | Latest |
| æ•°æ®åº“ | PostgreSQL | 15 |
| Python | Python | 3.11 |
| å‰ç«¯ UI | Streamlit | Latest |
| é•œåƒæ‰˜ç®¡ | GitHub Container Registry | - |

---

## ğŸ”§ éƒ¨ç½²è„šæœ¬è¯¦è§£

### è„šæœ¬ç»“æ„

éƒ¨ç½²è„šæœ¬ `docker-deploy.sh` é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼š

```bash
docker-deploy.sh                    # ä¸»è„šæœ¬ (2600+ è¡Œ)
â”œâ”€â”€ å…¨å±€é…ç½®                         # Line 1-150
â”‚   â”œâ”€â”€ é¢œè‰²å®šä¹‰
â”‚   â”œâ”€â”€ è·¯å¾„å˜é‡
â”‚   â””â”€â”€ æ—¥å¿—å‡½æ•°
â”‚
â”œâ”€â”€ å·¥å…·å‡½æ•°                         # Line 151-400
â”‚   â”œâ”€â”€ å‘½ä»¤æ£€æµ‹ (command_exists)
â”‚   â”œâ”€â”€ ç«¯å£æ£€æµ‹ (check_port_available)
â”‚   â”œâ”€â”€ é•œåƒæºæµ‹é€Ÿ (test_registry_speed)
â”‚   â””â”€â”€ æ¸…ç†å‡½æ•° (cleanup_*)
â”‚
â”œâ”€â”€ æ­¥éª¤ 1: ç¯å¢ƒæ£€æµ‹                 # Line 401-800
â”‚   â”œâ”€â”€ ç³»ç»Ÿä¿¡æ¯æ£€æµ‹
â”‚   â”œâ”€â”€ Docker æ£€æµ‹ä¸å®‰è£…
â”‚   â”œâ”€â”€ Docker Compose æ£€æµ‹
â”‚   â””â”€â”€ ç½‘ç»œè¿æ¥æµ‹è¯•
â”‚
â”œâ”€â”€ æ­¥éª¤ 2: é¡¹ç›®æ–‡ä»¶æ£€æŸ¥             # Line 801-1200
â”‚   â”œâ”€â”€ ä¸‹è½½/æ›´æ–° BettaFish
â”‚   â”œâ”€â”€ éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
â”‚   â””â”€â”€ æ¶æ„æ£€æµ‹ (ARM64/AMD64)
â”‚
â”œâ”€â”€ æ­¥éª¤ 3: API é…ç½®                # Line 1201-1850
â”‚   â”œâ”€â”€ è¯»å–ç°æœ‰é…ç½®
â”‚   â”œâ”€â”€ ç”¨æˆ·è¾“å…¥æ¥å£
â”‚   â”œâ”€â”€ å¯†é’¥éªŒè¯
â”‚   â””â”€â”€ Base URL å›ºå®šé…ç½®
â”‚
â”œâ”€â”€ æ­¥éª¤ 4: ç¯å¢ƒé…ç½®ç”Ÿæˆ             # Line 1851-2040
â”‚   â”œâ”€â”€ æ¡ä»¶å¤‡ä»½é€»è¾‘
â”‚   â”œâ”€â”€ .env æ–‡ä»¶ç”Ÿæˆ (7å¼•æ“+DB)
â”‚   â””â”€â”€ é…ç½®éªŒè¯
â”‚
â”œâ”€â”€ æ­¥éª¤ 5: é•œåƒæ‹‰å–                 # Line 2041-2230
â”‚   â”œâ”€â”€ é•œåƒæºæµ‹é€Ÿ
â”‚   â”œâ”€â”€ æ™ºèƒ½æºé€‰æ‹©
â”‚   â”œâ”€â”€ æ¡ä»¶å¤‡ä»½ docker-compose.yml
â”‚   â””â”€â”€ docker-compose pull
â”‚
â”œâ”€â”€ æ­¥éª¤ 6: æœåŠ¡å¯åŠ¨                 # Line 2231-2500
â”‚   â”œâ”€â”€ æ—§å®¹å™¨æ¸…ç†
â”‚   â”œâ”€â”€ æ—§é•œåƒæ¸…ç†
â”‚   â”œâ”€â”€ ç«¯å£å†²çªæ£€æµ‹ä¸ä¿®å¤
â”‚   â”œâ”€â”€ docker-compose up
â”‚   â””â”€â”€ å¥åº·æ£€æŸ¥
â”‚
â””â”€â”€ æ­¥éª¤ 7: éƒ¨ç½²å®Œæˆ                 # Line 2501-2600
    â”œâ”€â”€ æœåŠ¡çŠ¶æ€æ£€æŸ¥
    â”œâ”€â”€ åœ°å€è¾“å‡º (5ä¸ªæœåŠ¡)
    â””â”€â”€ æ—¥å¿—ä¿å­˜
```

### æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 1. æ™ºèƒ½é•œåƒæºé€‰æ‹©

**å®ç°åŸç†**ï¼š
```bash
test_registry_speed() {
    local registry=$1
    local start_time=$(date +%s%3N)

    # HEAD è¯·æ±‚æµ‹è¯•è¿æ¥é€Ÿåº¦
    if curl -m 3 -s -o /dev/null -w "%{http_code}" \
        "https://${registry}/v2/" > /dev/null 2>&1; then
        local end_time=$(date +%s%3N)
        echo $((end_time - start_time))
    else
        echo "9999"  # è¶…æ—¶æˆ–å¤±è´¥
    fi
}

# æµ‹è¯•ä¸¤ä¸ªé•œåƒæº
OFFICIAL_SPEED=$(test_registry_speed "ghcr.io")
NJU_SPEED=$(test_registry_speed "ghcr.nju.edu.cn")

# é€‰æ‹©æœ€å¿«çš„
if [ $OFFICIAL_SPEED -lt $NJU_SPEED ]; then
    BEST_REGISTRY="ghcr.io/666ghj/bettafish:latest"
else
    BEST_REGISTRY="ghcr.nju.edu.cn/666ghj/bettafish:latest"
fi
```

**æ”¯æŒçš„é•œåƒæº**ï¼š
- **å®˜æ–¹æº**: `ghcr.io/666ghj/bettafish:latest`
- **å›½å†…é•œåƒ**: `ghcr.nju.edu.cn/666ghj/bettafish:latest`

#### 2. ç«¯å£å†²çªè‡ªåŠ¨ä¿®å¤

**å®ç°åŸç†**ï¼š
```bash
# æ£€æµ‹ç«¯å£æ˜¯å¦å¯ç”¨
check_port_available() {
    local port=$1
    if command_exists lsof; then
        ! lsof -i :$port >/dev/null 2>&1
    elif command_exists nc; then
        ! nc -z localhost $port 2>/dev/null
    else
        return 0
    fi
}

# æŸ¥æ‰¾å¯ç”¨ç«¯å£ (5001-5010)
find_available_port() {
    for port in $(seq 5001 5010); do
        if check_port_available $port; then
            echo $port
            return 0
        fi
    done
    echo ""
    return 1
}

# è‡ªåŠ¨ä¿®å¤ç«¯å£é…ç½®
if ! check_port_available 5000; then
    AVAILABLE_PORT=$(find_available_port)

    # å¤‡ä»½å¹¶ä¿®æ”¹ docker-compose.yml
    sed -i "s/- \"5000:5000\"/- \"${AVAILABLE_PORT}:5000\"/" \
        docker-compose.yml
fi
```

#### 3. æ¡ä»¶å¤‡ä»½æœºåˆ¶

**å®ç°åŸç†**ï¼š
```bash
# .env é…ç½®æ–‡ä»¶æ¡ä»¶å¤‡ä»½
NEED_BACKUP=false

# æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
if [ "$SKIP_INPUT" != "true" ]; then
    # ç”¨æˆ·é‡æ–°è¾“å…¥é…ç½®
    NEED_BACKUP=true
elif [ -f "$ENV_FILE" ]; then
    # æ£€æŸ¥ Bocha å¯†é’¥æ˜¯å¦å˜åŒ–
    EXISTING_BOCHA=$(grep "^BOCHA_WEB_SEARCH_API_KEY=" \
        "$ENV_FILE" 2>/dev/null | cut -d'=' -f2)
    if [ "$EXISTING_BOCHA" != "$BOCHA_KEY" ]; then
        NEED_BACKUP=true
    fi
fi

# ä»…åœ¨éœ€è¦æ—¶å¤‡ä»½
if [ "$NEED_BACKUP" = true ] && [ -f "$ENV_FILE" ]; then
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    cp "$ENV_FILE" "$BACKUP_DIR/env_backup_${TIMESTAMP}.env"
fi
```

#### 4. è‡ªåŠ¨é•œåƒæ¸…ç†

**å®ç°åŸç†**ï¼š
```bash
# å®šä¹‰è¦æ¸…ç†çš„é•œåƒåˆ—è¡¨
IMAGES_TO_CHECK=(
    "bettafish:latest"                        # v1.x æœ¬åœ°æ„å»º
    "ghcr.nju.edu.cn/666ghj/bettafish:latest" # æœªä½¿ç”¨çš„é•œåƒ
    "postgres:15-alpine"                       # v1.x æ•°æ®åº“
    "python:3.11-slim"                        # åŸºç¡€é•œåƒ
)

# æ£€æµ‹å¹¶æ¸…ç†
for image in "${IMAGES_TO_CHECK[@]}"; do
    if docker images --format '{{.Repository}}:{{.Tag}}' | \
        grep -q "^${image}$"; then

        # å°è¯•åˆ é™¤ï¼ˆè¢«å ç”¨ä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
        if docker rmi "$image" >/dev/null 2>&1; then
            echo "âœ“ å·²åˆ é™¤: $image"
        else
            echo "â—‹ è·³è¿‡: $image (è¢«å ç”¨)"
        fi
    fi
done
```

---

## ğŸ³ Docker é…ç½®

### docker-compose.yml è¯¦è§£

```yaml
version: '3.8'

services:
  # ==================== ä¸»åº”ç”¨æœåŠ¡ ====================
  bettafish:
    image: ghcr.io/666ghj/bettafish:latest
    container_name: bettafish

    # ç«¯å£æ˜ å°„
    ports:
      - "5000:5000"   # Flask ä¸»æœåŠ¡
      - "8501:8501"   # Insight Engine
      - "8502:8502"   # Media Engine
      - "8503:8503"   # Query Engine

    # ç¯å¢ƒå˜é‡ï¼ˆä» .env åŠ è½½ï¼‰
    env_file:
      - .env

    # ä¾èµ–å…³ç³»ï¼ˆç­‰å¾…æ•°æ®åº“å¯åŠ¨ï¼‰
    depends_on:
      - db

    # ç½‘ç»œé…ç½®
    networks:
      - bettafish-network

    # é‡å¯ç­–ç•¥
    restart: unless-stopped

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== æ•°æ®åº“æœåŠ¡ ====================
  db:
    image: postgres:15
    container_name: bettafish-db

    # ç¯å¢ƒå˜é‡
    environment:
      POSTGRES_USER: bettafish
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: bettafish
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"

    # ç«¯å£æ˜ å°„
    ports:
      - "5432:5432"

    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - bettafish_db_data:/var/lib/postgresql/data

    # ç½‘ç»œé…ç½®
    networks:
      - bettafish-network

    # é‡å¯ç­–ç•¥
    restart: unless-stopped

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bettafish"]
      interval: 10s
      timeout: 5s
      retries: 5

# ==================== ç½‘ç»œé…ç½® ====================
networks:
  bettafish-network:
    driver: bridge

# ==================== æ•°æ®å·é…ç½® ====================
volumes:
  bettafish_db_data:
    driver: local
```

### å®¹å™¨é…ç½®è¯´æ˜

#### ä¸»åº”ç”¨å®¹å™¨ (bettafish)

**åŸºç¡€é•œåƒ**: `ghcr.io/666ghj/bettafish:latest`
- åŸºäº Python 3.11-slim
- é¢„å®‰è£…æ‰€æœ‰ä¾èµ–
- åŒ…å« 7 ä¸ª LLM å¼•æ“
- åŒ…å« 3 ä¸ª Streamlit UI

**ç«¯å£æ˜ å°„**:
```
ä¸»æœºç«¯å£ â†’ å®¹å™¨ç«¯å£
5000     â†’ 5000     (Flask ä¸»æœåŠ¡)
8501     â†’ 8501     (Insight Engine UI)
8502     â†’ 8502     (Media Engine UI)
8503     â†’ 8503     (Query Engine UI)
```

**ç¯å¢ƒå˜é‡**: ä» `.env` æ–‡ä»¶åŠ è½½ï¼ŒåŒ…å«ï¼š
- 7 ä¸ªå¼•æ“çš„ API å¯†é’¥å’Œé…ç½®
- æ•°æ®åº“è¿æ¥ä¿¡æ¯
- Tavily/Bocha æœç´¢å¯†é’¥

**é‡å¯ç­–ç•¥**: `unless-stopped`
- å®¹å™¨é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
- æ‰‹åŠ¨åœæ­¢æ—¶ä¸é‡å¯
- Docker å®ˆæŠ¤è¿›ç¨‹é‡å¯æ—¶è‡ªåŠ¨å¯åŠ¨

#### æ•°æ®åº“å®¹å™¨ (bettafish-db)

**åŸºç¡€é•œåƒ**: `postgres:15`
- å®˜æ–¹ PostgreSQL 15 é•œåƒ
- æ”¯æŒ UTF-8 å­—ç¬¦é›†

**æ•°æ®æŒä¹…åŒ–**:
- Volume: `bettafish_db_data`
- è·¯å¾„: `/var/lib/postgresql/data`
- é©±åŠ¨: `local`

**å­—ç¬¦é›†é…ç½®**:
```
POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
```

---

## ğŸ” ç¯å¢ƒå˜é‡

### .env æ–‡ä»¶ç»“æ„

```bash
# ====================== BETTAFISH æœåŠ¡é…ç½® ======================
HOST=0.0.0.0
PORT=5000

# ====================== æ•°æ®åº“é…ç½® ======================
DB_HOST=db                              # Docker ç½‘ç»œå†…çš„æœåŠ¡å
DB_PORT=5432
DB_USER=bettafish
DB_PASSWORD=bettafish_secure_TIMESTAMP  # åŠ¨æ€ç”Ÿæˆ
DB_NAME=bettafish
DB_CHARSET=utf8mb4
DB_DIALECT=postgresql

# ======================= LLM å¼•æ“é…ç½® =======================
# ç»Ÿä¸€ä½¿ç”¨ VibeAI API (Base URL å›ºå®š)

# 1. Insight Engine - æ´å¯Ÿå¼•æ“
INSIGHT_ENGINE_API_KEY=sk-proj-YOUR_KEY
INSIGHT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
INSIGHT_ENGINE_MODEL_NAME=gpt-4o

# 2. Media Engine - åª’ä½“å¼•æ“
MEDIA_ENGINE_API_KEY=sk-proj-YOUR_KEY
MEDIA_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
MEDIA_ENGINE_MODEL_NAME=gpt-4o

# 3. Query Engine - æŸ¥è¯¢å¼•æ“
QUERY_ENGINE_API_KEY=sk-proj-YOUR_KEY
QUERY_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
QUERY_ENGINE_MODEL_NAME=gpt-4o

# 4. Code Engine - ä»£ç å¼•æ“
CODE_ENGINE_API_KEY=sk-proj-YOUR_KEY
CODE_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
CODE_ENGINE_MODEL_NAME=gpt-4o

# 5. Main Agent Engine - ä¸»ä»£ç†å¼•æ“
MAIN_AGENT_ENGINE_API_KEY=sk-proj-YOUR_KEY
MAIN_AGENT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
MAIN_AGENT_ENGINE_MODEL_NAME=gpt-4o

# 6. DeepSeek Agent Engine - DeepSeek ä»£ç†å¼•æ“
DEEPSEEK_AGENT_ENGINE_API_KEY=sk-proj-YOUR_KEY
DEEPSEEK_AGENT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
DEEPSEEK_AGENT_ENGINE_MODEL_NAME=deepseek-chat

# 7. OpenAI Agent Engine - OpenAI ä»£ç†å¼•æ“
OPENAI_AGENT_ENGINE_API_KEY=sk-proj-YOUR_KEY
OPENAI_AGENT_ENGINE_BASE_URL=https://vibecodingapi.ai/v1
OPENAI_AGENT_ENGINE_MODEL_NAME=gpt-4o

# ======================= æœç´¢å·¥å…·é…ç½® =======================
# Tavily æœç´¢ (æ¨è)
TAVILY_API_KEY=tvly-YOUR_KEY

# Bocha æœç´¢ (å¯é€‰)
BOCHA_WEB_SEARCH_API_KEY=bocha-YOUR_KEY

# ======================= å…¶ä»–é…ç½® =======================
LOG_LEVEL=INFO
FLASK_ENV=production
```

### ç¯å¢ƒå˜é‡è¯´æ˜

#### å¿…éœ€å˜é‡

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `*_API_KEY` | LLM å¼•æ“ API å¯†é’¥ | `sk-proj-abc123...` |
| `DB_PASSWORD` | æ•°æ®åº“å¯†ç  | `bettafish_secure_1234567890` |
| `TAVILY_API_KEY` | Tavily æœç´¢å¯†é’¥ | `tvly-abc123...` |

#### å¯é€‰å˜é‡

| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `BOCHA_WEB_SEARCH_API_KEY` | Bocha æœç´¢å¯†é’¥ | ç©º |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `INFO` |
| `FLASK_ENV` | Flask ç¯å¢ƒ | `production` |

#### å›ºå®šå˜é‡ï¼ˆä¸å»ºè®®ä¿®æ”¹ï¼‰

| å˜é‡å | è¯´æ˜ | å€¼ |
|--------|------|-----|
| `*_BASE_URL` | API Base URL | `https://vibecodingapi.ai/v1` |
| `*_MODEL_NAME` | æ¨¡å‹åç§° | `gpt-4o` / `deepseek-chat` |
| `DB_HOST` | æ•°æ®åº“ä¸»æœº | `db` |
| `HOST` | æœåŠ¡ç›‘å¬åœ°å€ | `0.0.0.0` |
| `PORT` | æœåŠ¡ç›‘å¬ç«¯å£ | `5000` |

---

## ğŸŒ ç½‘ç»œæ¶æ„

### Docker ç½‘ç»œ

**ç½‘ç»œåç§°**: `bettafish-network`
**ç½‘ç»œé©±åŠ¨**: `bridge`

```bash
# æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…
docker network inspect bettafish-network
```

**ç½‘ç»œæ‹“æ‰‘**:
```
bettafish-network (172.18.0.0/16)
â”œâ”€â”€ bettafish      (172.18.0.2)
â”‚   â”œâ”€â”€ å¯¹å¤–: localhost:5000, 8501-8503
â”‚   â””â”€â”€ å¯¹å†…: å¯è®¿é—® db:5432
â”‚
â””â”€â”€ bettafish-db   (172.18.0.3)
    â”œâ”€â”€ å¯¹å¤–: localhost:5432
    â””â”€â”€ å¯¹å†…: æ¥å—æ¥è‡ª bettafish çš„è¿æ¥
```

### å®¹å™¨é—´é€šä¿¡

**é€šè¿‡æœåŠ¡åè®¿é—®**:
- ä¸»åº”ç”¨è¿æ¥æ•°æ®åº“: `postgresql://bettafish:PASSWORD@db:5432/bettafish`
- æœåŠ¡å `db` ä¼šè‡ªåŠ¨è§£æä¸ºæ•°æ®åº“å®¹å™¨çš„ IP

**ä¼˜åŠ¿**:
- æ— éœ€ç¡¬ç¼–ç  IP åœ°å€
- å®¹å™¨é‡å¯å IP å¯èƒ½å˜åŒ–ï¼ŒæœåŠ¡åå§‹ç»ˆæœ‰æ•ˆ
- éš”ç¦»çš„ç½‘ç»œç¯å¢ƒï¼Œå®‰å…¨æ€§æ›´å¥½

---

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–

### æ•°æ®å·é…ç½®

**æ•°æ®åº“æ•°æ®å·**: `bettafish_db_data`

```bash
# æŸ¥çœ‹æ•°æ®å·è¯¦æƒ…
docker volume inspect bettafish_db_data

# è¾“å‡ºç¤ºä¾‹
{
    "Driver": "local",
    "Mountpoint": "/var/lib/docker/volumes/bettafish_db_data/_data",
    "Name": "bettafish_db_data",
    "Scope": "local"
}
```

### æ•°æ®å­˜å‚¨

**PostgreSQL æ•°æ®**:
- ä½ç½®: `bettafish_db_data:/var/lib/postgresql/data`
- å†…å®¹: æ•°æ®åº“æ–‡ä»¶ã€WAL æ—¥å¿—ã€é…ç½®æ–‡ä»¶

**æ•°æ®æŒä¹…åŒ–ä¿è¯**:
- âœ… å®¹å™¨åˆ é™¤åæ•°æ®ä¿ç•™
- âœ… å®¹å™¨é‡å¯åæ•°æ®ä¿ç•™
- âœ… é•œåƒæ›´æ–°åæ•°æ®ä¿ç•™
- âŒ ä»… `docker-compose down -v` ä¼šåˆ é™¤æ•°æ®

### å¤‡ä»½å’Œæ¢å¤

#### å¤‡ä»½æ•°æ®åº“

```bash
# å¯¼å‡ºæ•°æ®åº“åˆ° SQL æ–‡ä»¶
docker-compose exec db pg_dump -U bettafish bettafish > backup.sql

# æˆ–è€…å¯¼å‡ºæ•´ä¸ªæ•°æ®å·
docker run --rm -v bettafish_db_data:/data \
    -v $(pwd):/backup ubuntu \
    tar czf /backup/db-backup.tar.gz /data
```

#### æ¢å¤æ•°æ®åº“

```bash
# ä» SQL æ–‡ä»¶æ¢å¤
docker-compose exec -T db psql -U bettafish bettafish < backup.sql

# æˆ–è€…æ¢å¤æ•´ä¸ªæ•°æ®å·
docker run --rm -v bettafish_db_data:/data \
    -v $(pwd):/backup ubuntu \
    tar xzf /backup/db-backup.tar.gz -C /
```

---

## âš™ï¸ é«˜çº§é…ç½®

### è‡ªå®šä¹‰ç«¯å£

**æ–¹æ³• 1: ä¿®æ”¹ docker-compose.yml**

```yaml
services:
  bettafish:
    ports:
      - "8080:5000"  # ä¸»æœåŠ¡æ”¹ä¸º 8080
      - "8501:8501"
      - "8502:8502"
      - "8503:8503"
```

**æ–¹æ³• 2: ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–**

```bash
# åˆ›å»º docker-compose.override.yml
cat > docker-compose.override.yml << EOF
version: '3.8'
services:
  bettafish:
    ports:
      - "8080:5000"
EOF

# é‡å¯æœåŠ¡
docker-compose up -d
```

### è‡ªå®šä¹‰ Base URL

è™½ç„¶éƒ¨ç½²è„šæœ¬å›ºå®šäº† Base URLï¼Œä½†éƒ¨ç½²åå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ï¼š

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
vim BettaFish-main/.env

# ä¿®æ”¹æ‰€æœ‰å¼•æ“çš„ BASE_URL
INSIGHT_ENGINE_BASE_URL=https://api.openai.com/v1
MEDIA_ENGINE_BASE_URL=https://api.openai.com/v1
# ... ä¿®æ”¹å…¶ä»–å¼•æ“

# é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
cd BettaFish-main
docker-compose restart bettafish
```

### ä½¿ç”¨ä¸åŒçš„ LLM æ¨¡å‹

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
vim BettaFish-main/.env

# ä¿®æ”¹ç‰¹å®šå¼•æ“çš„æ¨¡å‹
INSIGHT_ENGINE_MODEL_NAME=gpt-4-turbo
MEDIA_ENGINE_MODEL_NAME=gpt-4o-mini
DEEPSEEK_AGENT_ENGINE_MODEL_NAME=deepseek-coder

# é‡å¯æœåŠ¡
docker-compose restart bettafish
```

### é…ç½®èµ„æºé™åˆ¶

**é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨**:

```yaml
# åœ¨ docker-compose.yml ä¸­æ·»åŠ 
services:
  bettafish:
    deploy:
      resources:
        limits:
          cpus: '2.0'       # æœ€å¤šä½¿ç”¨ 2 ä¸ª CPU æ ¸å¿ƒ
          memory: 4G        # æœ€å¤šä½¿ç”¨ 4GB å†…å­˜
        reservations:
          cpus: '1.0'       # è‡³å°‘ä¿è¯ 1 ä¸ª CPU æ ¸å¿ƒ
          memory: 2G        # è‡³å°‘ä¿è¯ 2GB å†…å­˜

  db:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
```

### å¯ç”¨ HTTPS

**ä½¿ç”¨ Nginx åå‘ä»£ç†**:

```bash
# å®‰è£… Nginx
brew install nginx  # macOS
# æˆ–
sudo apt install nginx  # Linux

# é…ç½® Nginx
cat > /usr/local/etc/nginx/servers/bettafish.conf << EOF
server {
    listen 443 ssl http2;
    server_name bettafish.local;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }

    location /insight/ {
        proxy_pass http://localhost:8501/;
    }

    location /media/ {
        proxy_pass http://localhost:8502/;
    }

    location /query/ {
        proxy_pass http://localhost:8503/;
    }
}
EOF

# é‡å¯ Nginx
sudo nginx -s reload
```

---

## ğŸ› å¼€å‘è°ƒè¯•

### æŸ¥çœ‹å®¹å™¨æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs

# æŸ¥çœ‹ä¸»æœåŠ¡æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
docker-compose logs -f bettafish

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼ˆæœ€å 100 è¡Œï¼‰
docker-compose logs --tail=100 db

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—
docker-compose logs --since 2024-01-14T10:00:00
```

### è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥ä¸»åº”ç”¨å®¹å™¨
docker-compose exec bettafish bash

# è¿›å…¥æ•°æ®åº“å®¹å™¨
docker-compose exec db bash

# ä»¥ root ç”¨æˆ·è¿›å…¥
docker-compose exec -u root bettafish bash
```

### æ•°æ®åº“è°ƒè¯•

```bash
# è¿æ¥åˆ° PostgreSQL
docker-compose exec db psql -U bettafish bettafish

# æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
\l

# æŸ¥çœ‹è¡¨åˆ—è¡¨
\dt

# æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM conversations LIMIT 10;

# é€€å‡º
\q
```

### ç½‘ç»œè°ƒè¯•

```bash
# æŸ¥çœ‹å®¹å™¨ç½‘ç»œé…ç½®
docker inspect bettafish | grep -A 20 NetworkSettings

# æµ‹è¯•å®¹å™¨é—´è¿æ¥
docker-compose exec bettafish ping db

# æµ‹è¯•å¤–éƒ¨è¿æ¥
docker-compose exec bettafish curl https://vibecodingapi.ai/v1
```

### æ€§èƒ½åˆ†æ

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç‰¹å®šå®¹å™¨
docker stats bettafish bettafish-db

# è¾“å‡ºç¤ºä¾‹
CONTAINER       CPU %    MEM USAGE / LIMIT   MEM %
bettafish       5.23%    1.2GiB / 8GiB       15%
bettafish-db    0.87%    256MiB / 8GiB       3.2%
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. é•œåƒç¼“å­˜ä¼˜åŒ–

**ä½¿ç”¨æœ¬åœ°é•œåƒç¼“å­˜**:
```bash
# å¯¼å‡ºé•œåƒåˆ°æœ¬åœ°
docker save ghcr.io/666ghj/bettafish:latest -o bettafish.tar

# åœ¨å…¶ä»–æœºå™¨å¯¼å…¥
docker load -i bettafish.tar
```

### 2. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

**è°ƒæ•´ PostgreSQL é…ç½®**:
```bash
# åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
cat > postgresql.conf << EOF
# å†…å­˜é…ç½®
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 16MB

# å¹¶å‘é…ç½®
max_connections = 100

# WAL é…ç½®
wal_buffers = 16MB
checkpoint_completion_target = 0.9
EOF

# æŒ‚è½½åˆ°å®¹å™¨
# åœ¨ docker-compose.yml æ·»åŠ :
services:
  db:
    volumes:
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
```

### 3. åº”ç”¨æ€§èƒ½ä¼˜åŒ–

**å¯ç”¨ç”Ÿäº§æ¨¡å¼**:
```bash
# åœ¨ .env ä¸­è®¾ç½®
FLASK_ENV=production
LOG_LEVEL=WARNING  # å‡å°‘æ—¥å¿—è¾“å‡º

# é‡å¯æœåŠ¡
docker-compose restart bettafish
```

### 4. ç½‘ç»œä¼˜åŒ–

**ä½¿ç”¨ host ç½‘ç»œæ¨¡å¼**ï¼ˆä»… Linuxï¼‰:
```yaml
services:
  bettafish:
    network_mode: "host"
    # æ³¨æ„ï¼šä½¿ç”¨ host æ¨¡å¼éœ€è¦ç§»é™¤ ports é…ç½®
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. API å¯†é’¥å®‰å…¨

**ä¸è¦æäº¤ .env æ–‡ä»¶**:
```bash
# ç¡®ä¿ .gitignore åŒ…å«
echo ".env" >> .gitignore
echo "backups/" >> .gitignore
echo "logs/" >> .gitignore
```

**ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·**:
```bash
# æ¨èä½¿ç”¨ direnv
brew install direnv

# æˆ–ä½¿ç”¨ docker secrets (Swarm mode)
echo "sk-proj-YOUR_KEY" | docker secret create api_key -
```

### 2. æ•°æ®åº“å®‰å…¨

**ä¿®æ”¹é»˜è®¤å¯†ç **:
```bash
# åœ¨é¦–æ¬¡éƒ¨ç½²åä¿®æ”¹
docker-compose exec db psql -U bettafish -c \
    "ALTER USER bettafish WITH PASSWORD 'new_strong_password';"

# åŒæ­¥æ›´æ–° .env
DB_PASSWORD=new_strong_password

# é‡å¯æœåŠ¡
docker-compose restart
```

**é™åˆ¶æ•°æ®åº“è®¿é—®**:
```yaml
# docker-compose.yml
services:
  db:
    ports:
      - "127.0.0.1:5432:5432"  # ä»…æœ¬åœ°è®¿é—®
```

### 3. ç½‘ç»œå®‰å…¨

**ä½¿ç”¨é˜²ç«å¢™**:
```bash
# macOS å¯ç”¨é˜²ç«å¢™
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on

# Linux ä½¿ç”¨ ufw
sudo ufw allow 5000/tcp
sudo ufw allow 8501:8503/tcp
sudo ufw enable
```

**ä»…å…è®¸æœ¬åœ°è®¿é—®**:
```yaml
# docker-compose.yml
services:
  bettafish:
    ports:
      - "127.0.0.1:5000:5000"
      - "127.0.0.1:8501:8501"
      - "127.0.0.1:8502:8502"
      - "127.0.0.1:8503:8503"
```

### 4. å®¹å™¨å®‰å…¨

**å®šæœŸæ›´æ–°é•œåƒ**:
```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker-compose pull

# é‡å¯æœåŠ¡
docker-compose up -d
```

**æ‰«æé•œåƒæ¼æ´**:
```bash
# ä½¿ç”¨ Docker Scout
docker scout cves ghcr.io/666ghj/bettafish:latest

# æˆ–ä½¿ç”¨ Trivy
trivy image ghcr.io/666ghj/bettafish:latest
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/15/)
- [Flask æ–‡æ¡£](https://flask.palletsprojects.com/)

### BettaFish ç›¸å…³

- [GitHub ä»“åº“](https://github.com/666ghj/BettaFish)
- [Issues](https://github.com/666ghj/BettaFish/issues)
- [Discussions](https://github.com/666ghj/BettaFish/discussions)

### å·¥å…·é“¾æ¥

- [VibeAI API](https://vibecodingapi.ai/)
- [Tavily Search](https://tavily.com/)
- [Bocha Search](https://bocha.ai/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0
**æœ€åæ›´æ–°**: 2025-01-14
**ç»´æŠ¤è€…**: BettaFish å¼€å‘å›¢é˜Ÿ
